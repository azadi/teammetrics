#!/bin/sh
# Render all graphs from mailing lists which are contained in the database

# make sure all postings to debian-custom list will be moved to debian-blends
psql teammetrics --tuples-only --command "UPDATE listarchives SET project = 'debian-blends' WHERE project = 'debian-custom' AND message_id IN (SELECT message_id FROM (SELECT message_id, count(*) from listarchives WHERE project IN ('debian-custom', 'debian-blends') GROUP BY message_id ) AS tmp WHERE count = 1) ;"
# now remove those messages from debian-custom which were duplicated to get completely rid of this list
psql teammetrics --tuples-only --command "DELETE FROM listarchives WHERE project = 'debian-custom';"

# Merge pkg-scicomp-devel to debian-science-maintainers
psql teammetrics --tuples-only --command "UPDATE listarchives SET project = 'debian-science-maintainers' WHERE project = 'pkg-scicomp-devel' AND message_id IN (SELECT message_id FROM (SELECT message_id, count(*) from listarchives WHERE project IN ('pkg-scicomp-devel', 'debian-science-maintainers') GROUP BY message_id ) AS tmp WHERE count = 1) ;"
# now remove those messages from pkg-scicomp-devel which were duplicated to get completely rid of this list
psql teammetrics --tuples-only --command "DELETE FROM listarchives WHERE project = 'pkg-scicomp-devel';"

# Merge pkg-osm to pkg-grass
psql teammetrics --tuples-only --command "UPDATE listarchives SET project = 'pkg-grass-devel' WHERE project = 'pkg-osm-maint' AND message_id IN (SELECT message_id FROM (SELECT message_id, count(*) from listarchives WHERE project IN ('pkg-osm-maint', 'pkg-grass-devel') GROUP BY message_id ) AS tmp WHERE count = 1) ;"
# now remove those messages from pkg-osm-maint which were duplicated to get completely rid of this list
psql teammetrics --tuples-only --command "DELETE FROM listarchives WHERE project = 'pkg-osm-maint';"

# seems we do not get reliably rid of this noise generated by the imagej starter script
psql teammetrics --tuples-only --command "DELETE FROM listarchives WHERE subject LIKE '%ImageJ ports on%' AND  project = 'debian-med-packaging';"
# Fix broken project names ### FIXME: That's dirty!
psql teammetrics --tuples-only --command "UPDATE listarchives SET project = regexp_replace(project, '-Week-of$', '') WHERE project LIKE '%-Week-of';"
# FIXME!!! This should not happen but the quoted(!) string "David Pr√©vot" remains in database despite
#      git diff ac86eb4da3937d4be6b31b2b40399dacf903e9d8 ac86eb4da3937d4be6b31b2b40399dacf903e9d8^^
# Fix it manually for the moment
psql teammetrics --tuples-only --command "UPDATE listarchives SET name = regexp_replace(name, '\"(.*)\"', '\1') WHERE name LIKE '\"%\"';"

NUM=10
PDF=""
if [ "$1" = "pdf" ] ; then
    PDF="$NUM pdf"
fi

projects=`psql -t teammetrics -c 'SELECT project FROM listarchives GROUP BY project ;'`
for proj in $projects ; do
    ./author_stats $proj $PDF
done

projects=`psql -t teammetrics -c 'SELECT project FROM commitstat GROUP BY project ;'`
for proj in $projects ; do
    ./author_stats_commits $proj $PDF
    # Stop trying to create commitlines.  It often leads to errors and the result does not tell more than commitstats
    # ./author_stats_commitlines $proj $PDF
done

PDF=""
if [ "$1" = "pdf" ] ; then
    PDF="pdf"
fi

# render maintainer contribution per package
maintainer_per_package

# Render uploaders history
upload_history.py $PDF

# Render bug closer history
bug_close_history.py $PDF
