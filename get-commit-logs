#!/usr/bin/python

import ast
import logging
import json
import os
import re
import sys
import subprocess
import ConfigParser

webdir='/srv/alioth.debian.org/chroot/home/groups/teammetrics/htdocs/commitstats'
outputfile=webdir+'/commits.json'

LOG_FILE = 'commitstat.log'
LOG_SAVE_DIR = os.path.expanduser("~")+ '/log'
LOG_FILE_PATH = os.path.join(LOG_SAVE_DIR, LOG_FILE)

CONF_FILE = 'commitinfo.conf'
CONF_FILE_PATH = os.path.join(os.path.expanduser("~") + '/etc/teammetrics', CONF_FILE)

svncommit_re = re.compile('^(r\d+)\s*\|\s*([^ ]+)\s*\|\s*([-0-9]+)\s.*')
gitcommit_re = re.compile('^{"commit_id":"(.+)", "name":"(.*)", "e-mail":"(.*)", "commit_date":"([-0-9]+)"}$')
gitcheckduplicate_re = re.compile('^.*/(\w+).git/(\w+).git$')

def get_configuration():
    """Read configuration data of repositories whose logs have to be fetched.
    This function returns a list of the teams specified in the configuration
    file. The list is flattened and the section name is stripped.
    """

    config = ConfigParser.SafeConfigParser()
    config.read(CONF_FILE_PATH)
    # Get the names for the mailing lists from the config file.
    sections = config.sections()

    # Create a mapping of the list name to the address(es).
    team_names = {}
    for section in sections:
        teams = []
        # In case the url and lists options are not found, skip the section.
        try:
            team = config.get(section, 'team').splitlines()
        except ConfigParser.NoOptionError as detail:
            logging.error(detail)
            continue
        if not team:
            logging.error('Team option cannot be empty in %s' % section)
            continue

        # Mapping of list-name to list URL (or a list of list-URLs).
        teams.append(team)
        # Flatten the list..
        teams = sum(teams, [])
        team_names[section] = teams

    if not team_names:
        logging.error('No team(s) found in %s' % CONF_FILE)
        sys.exit(1)

    teams = []
    for section, team_name in team_names.iteritems():
        for each_team in team_name:
            teams.append(each_team)

    return teams

def start_logging():
    """Initialize the logger."""
    logging.basicConfig(filename=LOG_FILE_PATH,
                        level=logging.INFO,
                        format='%(asctime)s %(levelname)s: %(message)s')

def to_unicode(commit, encoding='utf-8'):
    value=commit['name']
    if isinstance(value, str):
        try:
            return value.decode(encoding)
        except UnicodeDecodeError, err:
            try:
                return value.decode('latin-1')
            except UnicodeDecodeError, err:
                logging.error("type(value) = %s; isinstance(value, str) = %s; err = %s" % (str(type(value)), str(isinstance(value, str)), str(err)))
                logging.error(commit)
                return '???'
    else:
        return unicode(value)

def get_git_commits(project):
    data=[]
    if project == 'debconf':
        # This is the Git archive of the package debconf rather than the Debian Conference team
        return data
    gitbase='/git/'+project
    if not os.path.isdir(gitbase):
        logging.warning('No such directory %s.  Ignore Git repositories of %s.' % (gitbase, project))
        return []
    gitdirs=os.popen('find %s -type d -name "*[-a-z0-9+].git" 2>/dev/null' % gitbase)
    packages=[]
    for gitr in gitdirs.readlines():
        gdata = {}
        gitr = gitr.strip()
        if not os.path.isdir(gitr):
            logging.error('%s is no directory.' % gitr)
            continue
        if gitcheckduplicate_re.match(gitr):
            # pkg-kde has ./kde-applications/kollision.git/kollision.git which leads to duplicated commit_ids
            logging.warning('Suspicious repository %s of project %s ignored' % (gitr, project))
            continue
        package = re.sub("^.*/([^/]*)\.git", '\\1', gitr)
        if package in packages:
            logging.info("Ignore duplicated package in project %s: %s (%s)" % (project, package, gitr))
            continue
        gdata['package'] = package
        gdata['commits'] = []
        gcmd=['git', 'log', '--no-merges', '--date=short', '--pretty=format:''{"commit_id":"%H", "name":"%an", "e-mail":"%ae", "commit_date":"%ad"}''', '--', 'debian'] # >> $data 2>/dev/null'
        try:
            gitcom = subprocess.Popen(gcmd, stdout=subprocess.PIPE, stderr=subprocess.PIPE, cwd=gitr)
        except OSError, err:
            logging.error(str(err))
            continue
        #gitcom.wait()
        (stdoutdata, stderrdata) = gitcom.communicate()
        if len(stderrdata) != 0:
            errdata = str(stderrdata).strip()
            if errdata.endswith("fatal: bad default revision 'HEAD'"):
                logging.warning("Git repository of project %s package %s not initialised" % (project, package))
                continue
            if errdata.endswith("fatal: Not a git repository (or any parent up to mount point /srv)"):
                logging.warning("No git repository in dir %s of project %s" % (gitr, project))
                continue
            logging.error('Problem when fetching Git commits of project %s package %s: %s' % (project, package, errdata))
        if len(stdoutdata) == 0:
            if len(stderrdata) != 0:
                continue
            logging.warning('Git log returned no data in project %s package %s ... do not restrict to debian/ dir only' % (project, package))
            gcmd=['git', 'log', '--no-merges', '--date=short', '--pretty=format:''{"commit_id":"%H", "name":"%an", "e-mail":"%ae", "commit_date":"%ad"}'''] # >> $data 2>/dev/null'
            gitcom = subprocess.Popen(gcmd, stdout=subprocess.PIPE, stderr=subprocess.PIPE, cwd=gitr)
            (stdoutdata, stderrdata) = gitcom.communicate()
            if len(stderrdata) != 0:
                logging.error('Problem when fetching Git commits of project %s package %s: %s' % (project, package, str(stderrdata).strip()))
            if len(stdoutdata) == 0:
                logging.warning('Git log returned no data in project %s package %s: Empty repository?' % (project, package))
                continue
        for com in stdoutdata.split('\n'):
            try:
                commit = ast.literal_eval(com)
            except SyntaxError:
                # some people have fun to spell their nicknames with "" pairs ...
                m = gitcommit_re.match(com)
                if not m:
                    logging.error('Problem importing single commit in project %s package %s: %s' % (project, package, str(com)))
                    continue
                commit = {}
                commit['commit_id']   = m.group(1)
                commit['name']        = m.group(2)
                commit['e-mail']      = m.group(3)
                commit['commit_date'] = m.group(4)
            commit['name'] = to_unicode(commit)
            gdata['commits'].append(commit)
        logging.debug("project %s package %s Git done" % (project, package))
        data.append(gdata)
        packages.append(package)
    return data

def get_svn_commits(project):
    data=[]
    # option -r 1:HEAD does some pre-sorting
    scmd='svn log -r 1:HEAD svn://localhost/svn/'+project+' 2> /dev/null'
    # here we use os.popen since subprocess.Popen() does not seem to end :-(
    svnout = os.popen(scmd)
    ids=[]
    for com in svnout.readlines():
        com = com.strip()
        if com == '':
            continue
        m = svncommit_re.match(com)
        if not m:
            continue
        if m.group(1) in ids:
            logging.info("Ignore duplicated commit in project %s: %s" % (project, com))
            continue
        ids.append(m.group(1))
        commit = {}
        commit['commit_id']   = m.group(1)
        commit['name']        = m.group(2)
        commit['commit_date'] = m.group(3)
        data.append(commit)
    return data

if __name__ == '__main__':
    start_logging()
    logging.info('\t\tStarting CommitStat')

    teams = get_configuration()
    logging.info('Measuring performance of %d teams' % len(teams))
    commitdata=[]
    for project in teams:
        data = {}
        data['project'] = project
        gd = get_git_commits(project)
        if gd:
            data['git'] = gd
        sv = get_svn_commits(project)
        if sv:
            data['svn'] = sv
        commitdata.append(data)
    f = open(outputfile, 'w')
    try:
        print >>f, json.dumps(commitdata, encoding='utf8')
    except UnicodeDecodeError, err:
        logging.error("%s --> try latin1" % str(err))
        print >>f, json.dumps(commitdata, encoding='latin1')
    f.close()
    os.system('bzip2 --force '+outputfile)
